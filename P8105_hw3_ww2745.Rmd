---
title: "p8105_hw3_ww2745"
author: "ww2745"
date: "2024-10-14"
output: github_document
---

```{r setup}
library(tidyverse)
library(ggridges)
library(patchwork)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```
##Problem 1


##Problem 2

Load and organize the dataset.
```{r load_tidy}
demo_df=
  read_csv(file="./data/nhanes_covar.csv",
           skip = 4) |> 
  janitor::clean_names() |> 
  filter(age>21) |> 
  drop_na() |> 
  mutate(
    sex = 
      case_match(
        sex, 
        1 ~ "male", 
        2 ~ "female"),
    sex = as.factor(sex)) |> 
  drop_na(sex)
    
demo_df

acc_df=
  read_csv(file="./data/nhanes_accel.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(
    min1:min1440,
    names_to = "minute",
    names_prefix = "min",
    values_to = "mims"
  ) |> 
  mutate(
    minute = as.factor(minute))
acc_df

merge_df = 
  left_join(acc_df, demo_df, by = "seqn")
merge_df
```

Exploratory analyses based on education level.

This is a table for the number of men and women in each education category.
```{r num_edu}
merge_df =
  mutate(merge_df,
    education = 
      case_match(
        education, 
        1 ~ "less_than_high_school", 
        2 ~ "high_school_equivalent",
        3 ~ "more_than_high_school"),
    education = as.factor(education),
    seqn = as.factor(seqn)) 

merge_df |> 
  group_by(sex, education) |>
  summarize(n_obs = n()) |> 
  pivot_wider(
    names_from = education,
    values_from = n_obs) |> 
  knitr::kable(digits = 1)
```
Most of the participants have education level at least equivalent to high school.

This graph shows the age distributions for men and women in each education category.
```{r age_distribution}
ggplot(merge_df, aes(x = age, fill = sex)) + 
  geom_density(alpha = .5) + 
  viridis::scale_fill_viridis(discrete = TRUE)
```
The highest peak for women is around 30, and for men is 80.

Now I'm going to make a graph showing the aggregated activity counts:



##Problem 3
Load and tidy the dataset.
```{r load_citi}
jan_20=
  read_csv(file="./data/Jan 2020 Citi.csv"
           ) |> 
  janitor::clean_names() |> 
  mutate(
    month="January",
    year="2020"
  )

jan_24=
  read_csv(file="./data/Jan 2024 Citi.csv"
           ) |> 
  janitor::clean_names() |> 
  mutate(
    month="January",
    year="2024"
  )

july_20=
  read_csv(file="./data/July 2020 Citi.csv"
           ) |> 
  janitor::clean_names() |> 
  mutate(
    month="July",
    year="2020"
  )

july_24=
  read_csv(file="./data/July 2024 Citi.csv"
           ) |> 
  janitor::clean_names() |> 
  mutate(
    month="July",
    year="2024"
  )

citi_df = 
  bind_rows(jan_20, jan_24, july_20, july_24)
```
This dataset contains 1% of all rides with a total duration less than 4 hours in each of four months. There are 99485 observations and nine columns.

Next is a table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. 
```{r table}
citi_df |> 
  group_by(month, year, member_casual) |> 
  summarize(
    num = n()
  ) |> 
  pivot_wider(
    names_from = member_casual,
    values_from = num
  ) |> 
  knitr::kable()
```
The number of casual ride and member are both increasing as time goes by.

Next is a table showing 5 most popular starting stations in July 2024. 

```{r pop_station}
popular_stations_df = 
 citi_df |> 
  filter(month == "July", year == "2024", .keep_all = TRUE) |> 
  group_by(start_station_name) |> 
  summarize(numer_of_rides = n()) |> 
  mutate(
    start_station_rank = min_rank(desc(numer_of_rides))
  ) |> 
  arrange(start_station_rank) |> 
  head(5)
```

Here is a plot to investigate the effects of day of the week, month, and year on median ride duration. 
```{r ride_duration}
citi_df |> 
  group_by(weekdays, month, year) |> 
  summarize(
    median_duration = median(duration, na.rm = TRUE),
    .group = "drop"
  ) |> 
  mutate(
    weekdays = factor(weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
  ) |> 
  ggplot(aes(x = weekdays, y = median_duration, group = year, fill = weekdays, color = month)) +
  geom_line(size = 1) +  
  facet_grid(year ~ month) +
  labs(
    title = "Median Ride Duration by Weekday across January and July of 2020 and 2024", 
    x = "Weekdays", 
    y = "Median Duration") +
  theme_minimal()
```

